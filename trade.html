 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Token Buy/Sell</title>
  <link href="https://fonts.googleapis.com/css?family=Arial:400,500,700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #181824;
      color: #e3e7ed;
      font-family: Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .trade-box {
      width: 95%;
      max-width: 350px;
      background: #232339;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(60,72,88,0.18);
      padding: 1.2em 1em;
      margin-top: 2em;
    }
    .token-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 0.5em;
      vertical-align: middle;
      background: #191923;
      border: 1px solid #232339;
    }
    .trade-title {
      font-size: 1.2em;
      color: #9945FF;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1em;
    }
    .input-row {
      margin: 1.1em 0;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    input, select {
      width: 100%;
      padding: 0.6em 0.9em;
      border-radius: 8px;
      border: 1px solid #232339;
      font-size: 1em;
      background: #181824;
      color: #e3e7ed;
      font-family: Arial, sans-serif;
    }
    .btn {
      background: #19FB9B;
      color: #181824;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1em;
      padding: 0.5em 1.1em;
      margin-top: 1em;
      cursor: pointer;
      transition: background 0.15s;
      width: 100%;
    }
    .btn:hover { filter: brightness(1.09); }
    .status {
      margin-top: 1em;
      text-align: center;
      font-size: 1em;
      color: #19FB9B;
    }
    .error {
      color: #ff5c91;
      margin-top: 1em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="trade-box" id="tradeBox"></div>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>
  <script>
    // Token list must match index.html
    const TOKENS = [
      { symbol: "SOL", name: "Solana", mint: "So11111111111111111111111111111111111111112", decimals: 9, image: "https://cryptologos.cc/logos/solana-sol-logo.png" },
      { symbol: "BONK", name: "Bonk", mint: "DezX1xQ6ZhhXPb9D5e8C2J9pYc3i8c1a6h8VfmYbZ3Qh", decimals: 5, image: "https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/DezX1xQ6ZhhXPb9D5e8C2J9pYc3i8c1a6h8VfmYbZ3Qh/logo.png" },
      { symbol: "MEW", name: "cat in a dogs world", mint: "6cA7QVY6L9Dn7dEyEfrXzQK6pQ6TjA2R8fLJwNr1cCzN", decimals: 6, image: "https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/6cA7QVY6L9Dn7dEyEfrXzQK6pQ6TjA2R8fLJwNr1cCzN/logo.png" },
      { symbol: "SAMO", name: "Samoyedcoin", mint: "7xKX2W5ZfVbknk8V2yZ6pR6A2K1v8R4F7k4G7U7vS8g", decimals: 9, image: "https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/7xKX2W5ZfVbknk8V2yZ6pR6A2K1v8R4F7k4G7U7vS8g/logo.png" }
    ];
    // Parse query params
    const params = new URLSearchParams(window.location.search);
    const tokenIdx = parseInt(params.get('token'), 10);
    const walletAddress = params.get('wallet');
    const token = TOKENS[tokenIdx];

    function setStatus(msg, error=false) {
      const box = document.getElementById("tradeBox");
      let el = box.querySelector(error ? ".error" : ".status");
      if (!el) {
        el = document.createElement("div");
        el.className = error ? "error" : "status";
        box.appendChild(el);
      }
      el.textContent = msg;
    }

    function clearStatus() {
      const box = document.getElementById("tradeBox");
      const st = box.querySelector(".status");
      const err = box.querySelector(".error");
      if (st) st.textContent = "";
      if (err) err.textContent = "";
    }

    function renderTrade() {
      document.getElementById("tradeBox").innerHTML = `
        <div class="trade-title">
          <img class="token-img" src="${token.image}" alt="${token.symbol}" />
          Trade ${token.name} (${token.symbol})
        </div>
        <div class="input-row">
          <label for="amount">Amount to buy/sell:</label>
          <input id="amount" type="number" min="0" placeholder="Amount">
          <label for="side">Type:</label>
          <select id="side">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
        </div>
        <button class="btn" onclick="startTrade()">Execute Trade</button>
        <div class="status"></div>
        <div class="error"></div>
      `;
    }

    // Jupiter settings
    const JUP_API = "https://quote-api.jup.ag/v6";

    window.startTrade = async function() {
      clearStatus();
      const amount = parseFloat(document.getElementById("amount").value);
      const side = document.getElementById("side").value;
      if (!amount || amount <= 0) {
        setStatus("Enter valid amount.", true);
        return;
      }
      if (!window.solana || !window.solana.isPhantom) {
        setStatus("Please use Phantom wallet in browser.", true);
        return;
      }
      setStatus("Fetching swap quote...");
      try {
        // For buy: swap SOL -> token
        // For sell: swap token -> SOL
        const fromMint = side === "buy" ? TOKENS[0].mint : token.mint;
        const toMint = side === "buy" ? token.mint : TOKENS[0].mint;
        // Convert amount to smallest units
        const decimals = side === "buy" ? TOKENS[0].decimals : token.decimals;
        const amountRaw = Math.floor(amount * Math.pow(10, decimals));
        // Quote
        const quoteUrl = `${JUP_API}/quote?inputMint=${fromMint}&outputMint=${toMint}&amount=${amountRaw}&slippageBps=30`;
        const quoteRes = await fetch(quoteUrl);
        const quote = await quoteRes.json();
        if (!quote.routePlan || !quote.routes || !quote.routes.length) throw new Error("No route found via Jupiter.");
        setStatus("Building swap transaction...");
        // Swap
        const swapRes = await fetch(`${JUP_API}/swap`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            route: quote.routes[0],
            userPublicKey: walletAddress,
            wrapUnwrapSOL: true,
            dynamicComputeUnitLimit: true
          })
        });
        const swapData = await swapRes.json();
        const swapTransaction = swapData.swapTransaction;
        if (!swapTransaction) throw new Error("Failed to build Jupiter transaction.");
        // Sign and send transaction
        setStatus("Signing transaction in wallet...");
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"));
        const tx = solanaWeb3.Transaction.from(Buffer.from(swapTransaction, "base64"));
        tx.feePayer = new solanaWeb3.PublicKey(walletAddress);
        tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;
        // Phantom wallet signing
        const signedTx = await window.solana.signTransaction(tx);
        setStatus("Sending transaction...");
        const txid = await connection.sendRawTransaction(signedTx.serialize());
        setStatus("Confirming transaction...");
        await connection.confirmTransaction(txid, "finalized");
        setStatus(`Trade successful! Transaction ID: ${txid}`);
      } catch (e) {
        setStatus("Trade failed: " + (e.message || e), true);
      }
    };

    window.addEventListener("DOMContentLoaded", renderTrade);
  </script>
</body>
</html>
