 <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FIXORIUM Wallet</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Solana web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>
  <!-- BN.js for big number -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bn.js/5.2.0/bn.min.js" crossorigin="anonymous"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #121212;
      color: #eee;
      height: 100vh;
      user-select: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background-color: #1e90ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      position: relative;
      color: white;
      user-select: none;
    }

    #logo-left {
      font-weight: 900;
      font-size: 1.4rem;
      letter-spacing: 1.2px;
      user-select: text;
      cursor: default;
      white-space: nowrap;
    }

    #logo-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
      width: 400px;
      height: 600px;
      background: url("https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/info/logo.png") no-repeat center;
      background-size: contain;
      opacity: 0.05;
      z-index: 0;
    }

    #connectWalletBtn {
      background-color: #005ecb;
      font-size: 0.8rem;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 700;
      min-width: 100px;
      text-align: center;
      white-space: nowrap;
      user-select: none;
      cursor: pointer;
      border: none;
      color: white;
      transition: background-color 0.2s ease;
      position: relative;
      z-index: 10;
    }

    #connectWalletBtn:hover:not([disabled]) {
      background-color: #004099;
    }

    #connectWalletBtn[disabled] {
      background-color: #444444;
      cursor: default;
    }

    main {
      flex-grow: 1;
      overflow-y: auto;
      padding: 16px;
      position: relative;
    }

    #totalBalance {
      font-size: 2.8rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 15px;
      user-select: text;
    }

    .tokens-list {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      margin: 0 auto;
      max-width: 520px;
      border: 1px solid #333;
      border-radius: 14px;
      background: #1e2a38;
      padding: 12px 16px;
      box-shadow: 0 0 10px #1e90ff88;
    }

    .token-item {
      background: #2a3a54;
      margin-bottom: 10px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      color: #eee;
    }

    .token-logo {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      object-fit: contain;
      margin-right: 14px;
      user-select: none;
      flex-shrink: 0;
    }

    .token-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      user-select: text;
    }

    .token-symbol {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .token-balance,
    .token-price {
      font-size: 0.9rem;
    }

    .token-price {
      color: #a5caff;
    }

    /* Buttons container outside content area, absolute top-right */
    .button-bar {
      position: fixed;
      top: 50px;
      right: 20px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .button-bar button {
      min-width: 110px;
      padding: 8px 12px;
      font-size: 0.95rem;
      border-radius: 8px;
      font-weight: 700;
      background-color: #1e90ff;
      border: none;
      color: white;
      user-select: none;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }

    .button-bar button:hover {
      background-color: #004c9e;
    }

    [hidden] {
      display: none !important;
    }

    /* Overlays for Deposit, Withdraw, Swap sections */

    .overlay-bg {
      position: fixed;
      inset: 0;
      background-color: #000c;
      backdrop-filter: blur(2px);
      user-select: none;
      z-index: 18;
    }

    .overlay-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e2a38;
      border-radius: 16px;
      box-shadow: 0 0 20px #1e90ffaa;
      max-width: 480px;
      width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px 28px 28px;
      color: #eee;
      z-index: 19;
      user-select: text;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .overlay-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 900;
      user-select: text;
    }

    .overlay-close-btn {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #eee;
      user-select: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-weight: 700;
    }

    /* Footer ad */

    footer {
      background-color: #1e90ff;
      height: 60px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      user-select: none;
      box-shadow: 0 -2px 10px #1e90ffcc;
      flex-shrink: 0;
    }
  </style>
</head>

<body>
  <header>
    <div id="logo-left">FIXORIUM</div>
    <button id="connectWalletBtn">Connect</button>
    <div id="logo-center"></div>
  </header>

  <main>
    <div id="root"></div>
  </main>

  <footer>FIXERCOIN Commercial - Experience Reliable Solana Token Exchange with FIXORIUM</footer>

  <script type="text/javascript">
    (() => {
      const e = React.createElement;
      const { useState, useEffect, useCallback } = React;
      const {
        Connection,
        PublicKey,
        Transaction,
        SystemProgram,
        TransactionInstruction,
        SYSVAR_RENT_PUBKEY,
      } = solanaWeb3;
      const BN = window.BN;

      // RPC & API
      const connection = new Connection("https://solana-api.projectserum.com", "confirmed");
      const JUPITER_API_BASE = "https://quote-api.jup.ag/v6";
      const TOKEN_PROGRAM_ID = new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
      const ASSOCIATED_TOKEN_PROGRAM_ID = new PublicKey("ATokenGPvR1HuTRHqpPDp7HHTRmAg3zRk6USH3UUZsM");
      const SOL_MINT = "So11111111111111111111111111111111111111112";

      // Tokens list (customize here)
      const tokensList = [
        { mint: null, symbol: "SOL", name: "Solana", decimals: 9, logoURI: "https://cryptologos.cc/logos/solana-sol-logo.svg?v=014" },
        { mint: new PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"), symbol: "USDC", name: "USD Coin", decimals: 6, logoURI: "https://cryptologos.cc/logos/usd-coin-usdc-logo.svg?v=014" },
        { mint: new PublicKey("Es9vMFrzaCER7N1TvjVqauDziYbPEmxW5M9VpX1TTd8C"), symbol: "USDT", name: "Tether USD", decimals: 6, logoURI: "https://cryptologos.cc/logos/tether-usdt-logo.svg?v=014" },
        { mint: new PublicKey("D2mGkp5D43jirFeapx8UZmpiH7FaWeX1eUWy94q1F2hD"), symbol: "FIXR", name: "FixerCoin", decimals: 9, logoURI: "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/D2mGkp5D43jirFeapx8UZmpiH7FaWeX1eUWy94q1F2hD/logo.png" },
      ];

      async function findAssociatedTokenAddress(walletAddress, tokenMintAddress) {
        return (
          await PublicKey.findProgramAddress([walletAddress.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), tokenMintAddress.toBuffer()], ASSOCIATED_TOKEN_PROGRAM_ID)
        )[0];
      }

      function toBaseUnits(amountStr, decimals) {
        try {
          const val = parseFloat(amountStr);
          if (isNaN(val) || val <= 0) return 0;
          return Math.round(val * 10 ** decimals);
        } catch {
          return 0;
        }
      }

      function TokenLogo({ token }) {
        if (token.logoURI)
          return e("img", { src: token.logoURI, alt: token.symbol, className: "token-logo" });
        return e("div", { className: "token-logo", style: { backgroundColor: "#444", fontWeight: "bold", fontSize: 14, textAlign: "center", lineHeight: "36px", borderRadius: 6, userSelect: "none" }, title: token.name }, token.symbol);
      }

      function shortAddress(addr) {
        if (!addr) return "";
        const s = addr.toString();
        if (s.length < 10) return s;
        return s.slice(0, 4) + "..." + s.slice(-4);
      }

      function App() {
        // Wallet and provider
        const [provider, setProvider] = useState(null);
        const [walletConnected, setWalletConnected] = useState(false);
        const [publicKey, setPublicKey] = useState(null);
        // Balances and prices
        const [balances, setBalances] = useState({});
        const [prices, setPrices] = useState({});
        // UI States
        const [showDeposit, setShowDeposit] = useState(false);
        const [showWithdraw, setShowWithdraw] = useState(false);
        const [showSwap, setShowSwap] = useState(false);
        const [error, setError] = useState("");
        const [status, setStatus] = useState("");

        // Withdraw states
        const [withdrawAddress, setWithdrawAddress] = useState("");
        const [withdrawAmount, setWithdrawAmount] = useState("");

        // SPL withdraw states
        const [splWithdrawTokenSymbol, setSplWithdrawTokenSymbol] = useState("FIXR");
        const [splWithdrawAddress, setSplWithdrawAddress] = useState("");
        const [splWithdrawAmount, setSplWithdrawAmount] = useState("");

        // Swap states (SOL <-> FIXR only)
        const swapFromToken = tokensList[0]; // SOL
        const swapToToken = tokensList.find(t => t.symbol === "FIXR");
        const [swapAmount, setSwapAmount] = useState("");
        const [slippage, setSlippage] = useState("0.5");
        const [routes, setRoutes] = useState([]);
        const [selectedRoute, setSelectedRoute] = useState(null);
        const [loadingQuotes, setLoadingQuotes] = useState(false);
        const [swapping, setSwapping] = useState(false);
        const [withdrawing, setWithdrawing] = useState(false);

        // Detect Phantom
        useEffect(() => {
          const p = (() => {
            if (window.solana && window.solana.isPhantom) return window.solana;
            if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
            return null;
          })();
          setProvider(p);
        }, []);

        // Connect wallet
        const connectWallet = useCallback(async () => {
          setError("");
          if (!provider) {
            setError("Phantom Wallet not found. Please install Phantom.");
            return;
          }
          try {
            const resp = await provider.connect();
            setPublicKey(new PublicKey(resp.publicKey.toString()));
            setWalletConnected(true);
            setError("");
            setStatus("");
            // Update button text (handled outside React)
            document.getElementById('connectWalletBtn').innerText = shortAddress(resp.publicKey.toString());
          } catch {
            setError("Wallet connection rejected or failed.");
          }
        }, [provider]);

        // Disconnect wallet
        const disconnectWallet = async () => {
          if (!provider) return;
          try { await provider.disconnect(); } catch { }
          setWalletConnected(false);
          setPublicKey(null);
          setBalances({});
          setPrices({});
          setRoutes([]);
          setSelectedRoute(null);
          setStatus("");
          setError("");
          setSwapAmount("");
          setWithdrawAmount("");
          setWithdrawAddress("");
          setSplWithdrawAmount("");
          setSplWithdrawAddress("");
          document.getElementById('connectWalletBtn').innerText = "Connect";
          // Also hide all modals
          setShowDeposit(false);
          setShowWithdraw(false);
          setShowSwap(false);
        };

        // Setup connect button click for React
        useEffect(() => {
          const btn = document.getElementById('connectWalletBtn');
          if (!btn) return;
          btn.onclick = () => {
            if (walletConnected) disconnectWallet();
            else connectWallet();
          };
        }, [walletConnected, connectWallet, disconnectWallet]);

        // Listen wallet events inside React
        useEffect(() => {
          if (!provider) return;
          const onConnect = (pk) => {
            setPublicKey(new PublicKey(pk.toString()));
            setWalletConnected(true);
            setError("");
            setStatus("");
            document.getElementById('connectWalletBtn').innerText = shortAddress(pk.toBase58());
          };
          const onDisconnect = () => {
            setWalletConnected(false);
            setPublicKey(null);
            setBalances({});
            setPrices({});
            setRoutes([]);
            setSelectedRoute(null);
            setError("");
            setStatus("");
            setSwapAmount("");
            setWithdrawAmount("");
            setWithdrawAddress("");
            setSplWithdrawAmount("");
            setSplWithdrawAddress("");
            document.getElementById('connectWalletBtn').innerText = "Connect";
            setShowDeposit(false);
            setShowWithdraw(false);
            setShowSwap(false);
          };
          provider.on("connect", onConnect);
          provider.on("disconnect", onDisconnect);
          if (provider.isConnected) onConnect(provider.publicKey);
          return () => {
            provider.removeListener && provider.removeListener("connect", onConnect);
            provider.removeListener && provider.removeListener("disconnect", onDisconnect);
          };
        }, [provider]);

        // Fetch balances and prices
        useEffect(() => {
          if (!walletConnected || !publicKey) {
            setBalances({});
            setPrices({});
            return;
          }
          async function fetchAll() {
            setError("");
            try {
              // SOL balance
              const solLamports = await connection.getBalance(publicKey);
              const newBalances = { SOL: solLamports / 1e9 };

              // SPL balances
              await Promise.all(tokensList.map(async t => {
                if (!t.mint) return;
                try {
                  const ata = await findAssociatedTokenAddress(publicKey, t.mint);
                  const info = await connection.getParsedAccountInfo(ata);
                  newBalances[t.symbol] = info.value?.data?.parsed?.info?.tokenAmount?.uiAmount || 0;
                } catch {
                  newBalances[t.symbol] = 0;
                }
              }));

              setBalances(newBalances);

              // CoinGecko ID mapping - fixr uses ethereum (placeholder)
              const cgMap = {
                SOL: "solana",
                USDC: "usd-coin",
                USDT: "tether",
                FIXR: "ethereum",
              };
              const cgIds = Object.values(cgMap).filter(Boolean).join(",");
              const resp = await axios.get(`https://api.coingecko.com/api/v3/simple/price?ids=${cgIds}&vs_currencies=usd`);
              const pricesObj = {};
              Object.entries(cgMap).forEach(([sym, id]) => {
                pricesObj[sym] = resp.data[id]?.usd || 0;
              });
              setPrices(pricesObj);
            } catch (e) {
              setError("Error loading balances or prices.");
            }
          }
          fetchAll();
        }, [walletConnected, publicKey]);

        // Total USD balance
        const totalBalanceUSD = Object.keys(balances).reduce((acc, sym) => acc + (balances[sym] || 0) * (prices[sym] || 0), 0);

        // Deposit modal content (just instruction - SOL network only)
        const Deposit = () => e("div", { className: "overlay-bg", onClick: () => setShowDeposit(false) },
          e("div", {
            className: "overlay-panel",
            onClick: e => e.stopPropagation()
          },
            e("div", { className: "overlay-header" },
              e("h2", null, "Deposit Instruction"),
              e("button", {
                className: "overlay-close-btn",
                "aria-label": "Close deposit",
                onClick: () => setShowDeposit(false)
              }, "×")
            ),
            e("p", { style: { userSelect: "text", fontWeight: "600", fontSize: '1rem' } },
              "To deposit SOL or SPL tokens, send tokens to your wallet:",
              e("br"),
              e("code", { style: { userSelect: "text", wordBreak: "break-word" } }, publicKey.toBase58())
            ),
            e("small", null, "Note: Only Solana network tokens are supported.")
          )
        );

        // Withdraw modal
        const Withdraw = () => {
          const [wAddress, setWAddress] = useState("");
          const [wAmount, setWAmount] = useState("");
          const [sAddress, setSAddress] = useState("");
          const [sAmount, setSAmount] = useState("");
          const [selTokenSym, setSelTokenSym] = useState("FIXR");

          // Update parent states for withdraw inputs
          useEffect(() => setWithdrawAddress(wAddress), [wAddress]);
          useEffect(() => setWithdrawAmount(wAmount), [wAmount]);
          useEffect(() => setSplWithdrawAddress(sAddress), [sAddress]);
          useEffect(() => setSplWithdrawAmount(sAmount), [sAmount]);
          useEffect(() => setSplWithdrawTokenSymbol(selTokenSym), [selTokenSym]);

          useEffect(() => {
            setWAddress(withdrawAddress);
            setWAmount(withdrawAmount);
            setSAddress(splWithdrawAddress);
            setSAmount(splWithdrawAmount);
            setSelTokenSym(splWithdrawTokenSymbol);
          }, []);

          return e("div", { className: "overlay-bg", onClick: () => setShowWithdraw(false) },
            e("div", {
              className: "overlay-panel",
              onClick: e => e.stopPropagation()
            },
              e("div", { className: "overlay-header" },
                e("h2", null, "Withdraw"),
                e("button", {
                  className: "overlay-close-btn",
                  "aria-label": "Close withdraw",
                  onClick: () => setShowWithdraw(false)
                }, "×")
              ),

              e("fieldset", null,
                e("legend", null, "Withdraw SOL"),
                e("label", { htmlFor: "withdrawAddress" }, "Recipient Address"),
                e("input", {
                  id: "withdrawAddress", type: "text",
                  value: wAddress,
                  onChange: e => setWAddress(e.target.value),
                  placeholder: "Solana recipient address"
                }),
                e("label", { htmlFor: "withdrawAmount" }, "Amount (SOL)"),
                e("input", {
                  id: "withdrawAmount", type: "number", min: "0", step: "any",
                  value: wAmount,
                  onChange: e => setWAmount(e.target.value),
                  placeholder: "0"
                }),
                e("button", {
                  onClick: () => withdrawSol(),
                  disabled: withdrawing || !wAddress || !wAmount
                }, withdrawing ? "Withdrawing..." : "Withdraw SOL")
              ),

              e("fieldset", { style: { marginTop: '1rem' } },
                e("legend", null, "Withdraw SPL Token"),
                e("label", { htmlFor: "splWithdrawTokenSelect" }, "Select Token"),
                e("select", {
                  id: "splWithdrawTokenSelect",
                  value: selTokenSym,
                  onChange: e => setSelTokenSym(e.target.value)
                },
                  tokensList.filter(t => t.symbol !== "SOL").map(t =>
                    e("option", { key: t.symbol, value: t.symbol }, t.symbol)
                  )
                ),
                e("label", { htmlFor: "splWithdrawAddress" }, "Recipient Address"),
                e("input", {
                  id: "splWithdrawAddress", type: "text",
                  value: sAddress,
                  onChange: e => setSAddress(e.target.value),
                  placeholder: "Recipient Solana address"
                }),
                e("label", { htmlFor: "splWithdrawAmount" }, `Amount (${selTokenSym})`),
                e("input", {
                  id: "splWithdrawAmount", type: "number", min: "0", step: "any",
                  value: sAmount,
                  onChange: e => setSAmount(e.target.value),
                  placeholder: "0"
                }),
                e("button", {
                  onClick: () => withdrawSPLToken(),
                  disabled: withdrawing || !sAddress || !sAmount
                }, withdrawing ? `Withdrawing ${selTokenSym}...` : `Withdraw ${selTokenSym}`)
              ),

              error && e("p", { className: "error" }, error),
              status && e("p", { className: "status" }, status),
            )
          );
        };

        // Swap modal (only SOL->FIXR)
        const Swap = () => {
          const [amount, setAmount] = useState(swapAmount);
          const [localSlippage, setLocalSlippage] = useState(slippage);

          useEffect(() => setSwapAmount(amount), [amount]);
          useEffect(() => setSlippage(localSlippage), [localSlippage]);
          useEffect(() => {
            setAmount(swapAmount);
            setLocalSlippage(slippage);
          }, []);

          const onGetQuotes = () => getSwapQuotes();
          const onExecuteSwap = () => executeSwap();

          return e("div", { className: "overlay-bg", onClick: () => setShowSwap(false) },
            e("div", {
              className: "overlay-panel",
              onClick: e => e.stopPropagation()
            },
              e("div", { className: "overlay-header" },
                e("h2", null, "Swap SOL → FIXR"),
                e("button", {
                  className: "overlay-close-btn",
                  "aria-label": "Close swap",
                  onClick: () => setShowSwap(false)
                }, "×")
              ),

              e("label", { htmlFor: "swapAmountInput" }, `Amount (SOL):`),
              e("input", {
                id: "swapAmountInput", type: "number", min: "0", step: "any",
                value: amount,
                onChange: e => setAmount(e.target.value),
                placeholder: "0"
              }),

              e("label", { htmlFor: "swapSlippageInput" }, "Slippage tolerance (%)"),
              e("input", {
                id: "swapSlippageInput", type: "number", min: "0", max: "10", step: "0.1",
                value: localSlippage,
                onChange: e => setLocalSlippage(e.target.value),
                placeholder: "0.5"
              }),

              e("button", { type: "button", onClick: onGetQuotes, disabled: loadingQuotes || swapping || !amount || parseFloat(amount) <= 0, style: { width: "100%", marginTop: "10px" } },
                loadingQuotes ? "Loading Quotes..." : "Get Swap Quotes"),

              routes.length > 0 && e("fieldset", { style: { marginTop: '16px' } },
                routes.map(route => {
                  const expectedOut = (parseInt(route.outAmount) / 10 ** swapToToken.decimals).toFixed(6);
                  const priceImpactPct = (route.priceImpactPct * 100).toFixed(3);
                  const selected = selectedRoute && selectedRoute.id === route.id;
                  return e("div", {
                    key: route.id,
                    className: "route-box" + (selected ? " selected" : ""),
                    onClick: () => setSelectedRoute(route),
                    tabIndex: 0,
                    role: "button",
                    "aria-pressed": selected,
                    style: { marginBottom: 12 }
                  },
                    e("div", null, e("b", null, "Expected Out: "), expectedOut + " FIXR"),
                    e("div", null, e("b", null, "Price Impact: "), priceImpactPct + "%"));
                }),
                e("button", {
                  type: "button",
                  disabled: swapping || !selectedRoute,
                  onClick: onExecuteSwap,
                  style: { width: '100%', marginTop: 6 }
                }, swapping ? "Swapping..." : `Swap SOL → FIXR`)
              ),

              error && e("p", { className: "error" }, error),
              status && e("p", { className: "status" }, status),
            )
          );
        };

        // Withdraw and swap functions from earlier code (unchanged)
        // Withdraw SOL
        async function withdrawSol() {
          setError("");
          setStatus("");
          if (!walletConnected || !publicKey || !provider) {
            setError("Wallet not connected.");
            return;
          }
          if (!withdrawAmount || isNaN(parseFloat(withdrawAmount)) || parseFloat(withdrawAmount) <= 0) {
            setError("Enter valid withdraw amount.");
            return;
          }
          let amountVal = parseFloat(withdrawAmount);
          if (amountVal > (balances.SOL || 0)) {
            setError("Withdraw amount exceeds SOL balance.");
            return;
          }
          let dest;
          try {
            dest = new PublicKey(withdrawAddress);
          } catch {
            setError("Invalid recipient address.");
            return;
          }
          setWithdrawing(true);
          try {
            const tx = new Transaction().add(SystemProgram.transfer({ fromPubkey: publicKey, toPubkey: dest, lamports: Math.round(amountVal * 1e9) }));
            tx.feePayer = publicKey;
            const latest = await connection.getLatestBlockhash();
            tx.recentBlockhash = latest.blockhash;
            const signed = await provider.signTransaction(tx);
            const txid = await connection.sendRawTransaction(signed.serialize());
            setStatus(`Withdraw SOL tx sent: ${txid}`);
            await connection.confirmTransaction(txid);
            setStatus(`Withdraw SOL tx confirmed: ${txid}`);
            setWithdrawAmount("");
            setWithdrawAddress("");
            const lamports = await connection.getBalance(publicKey);
            setBalances(b => ({ ...b, SOL: lamports / 1e9 }));
          } catch (e) {
            setError("Withdraw SOL failed: " + (e.message || e.toString()));
          }
          setWithdrawing(false);
        }

        // Withdraw SPL Token
        async function withdrawSPLToken() {
          setError("");
          setStatus("");
          if (!walletConnected || !publicKey || !provider) {
            setError("Wallet not connected.");
            return;
          }
          if (!splWithdrawAmount || isNaN(parseFloat(splWithdrawAmount)) || parseFloat(splWithdrawAmount) <= 0) {
            setError("Enter valid token withdraw amount.");
            return;
          }
          if (!splWithdrawAddress) {
            setError("Enter recipient address.");
            return;
          }
          let recipient;
          try {
            recipient = new PublicKey(splWithdrawAddress);
          } catch {
            setError("Invalid recipient address.");
            return;
          }
          const amount = parseFloat(splWithdrawAmount);
          const tokenData = tokensList.find(t => t.symbol === splWithdrawTokenSymbol);
          if (!tokenData || !tokenData.mint) { setError("Invalid token selected."); return; }
          if ((balances[tokenData.symbol] || 0) < amount) {
            setError(`Insufficient ${tokenData.symbol} balance.`);
            return;
          }
          setWithdrawing(true);
          try {
            const senderATA = await findAssociatedTokenAddress(publicKey, tokenData.mint);
            const recipientATA = await findAssociatedTokenAddress(recipient, tokenData.mint);
            const recipientInfo = await connection.getAccountInfo(recipientATA);
            const instructions = [];
            if (!recipientInfo) {
              instructions.push(new TransactionInstruction({
                keys: [
                  { pubkey: publicKey, isSigner: true, isWritable: true },
                  { pubkey: recipientATA, isSigner: false, isWritable: true },
                  { pubkey: recipient, isSigner: false, isWritable: false },
                  { pubkey: tokenData.mint, isSigner: false, isWritable: false },
                  { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
                  { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
                  { pubkey: SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
                ],
                programId: ASSOCIATED_TOKEN_PROGRAM_ID,
                data: Buffer.from([]),
              }));
            }
            const rawAmount = new BN(Math.round(amount * 10 ** tokenData.decimals));
            const data = Buffer.alloc(9);
            data.writeUInt8(3, 0);
            rawAmount.toArrayLike(Buffer, "le", 8).copy(data, 1);
            instructions.push(new TransactionInstruction({
              keys: [
                { pubkey: senderATA, isSigner: false, isWritable: true },
                { pubkey: recipientATA, isSigner: false, isWritable: true },
                { pubkey: publicKey, isSigner: true, isWritable: false },
              ],
              programId: TOKEN_PROGRAM_ID,
              data,
            }));

            const tx = new Transaction().add(...instructions);
            tx.feePayer = publicKey;
            const blockhash = (await connection.getLatestBlockhash()).blockhash;
            tx.recentBlockhash = blockhash;
            const signed = await provider.signTransaction(tx);
            const txid = await connection.sendRawTransaction(signed.serialize());
            setStatus(`SPL Token withdraw tx sent: ${txid}`);
            await connection.confirmTransaction(txid);
            setStatus(`SPL Token withdraw tx confirmed: ${txid}`);
            setBalances(b => ({ ...b, [tokenData.symbol]: b[tokenData.symbol] - amount }));
            setSplWithdrawAmount("");
            setSplWithdrawAddress("");
          } catch (e) {
            setError("Withdraw SPL token failed: " + (e.message || e.toString()));
          }
          setWithdrawing(false);
        }

        // Swap functions same as discussed (omit code here, use previously provided ones)
        // ... (You can similarly add swap functions if needed)

        // For this version only show tokens and total balance on main page + modal overlay for Deposit/Withdraw/Swap on demand

        // Modal switch handler:
        function closeAllModals() {
          setShowDeposit(false);
          setShowWithdraw(false);
          setShowSwap(false);
          setError("");
          setStatus("");
        }

        // Component for modal overlays container wrapper + keyboard esc to close
        function Overlay({ children }) {
          useEffect(() => {
            const onEsc = (e) => {
              if (e.key === "Escape") closeAllModals();
            };
            window.addEventListener("keydown", onEsc);
            return () => window.removeEventListener("keydown", onEsc);
          }, []);
          return e("div", null, children);
        }

        return e("div", null,
          e("div", { id: "totalBalance", title: "Total USD Balance" }, `$${totalBalanceUSD.toFixed(2)}`),
          e("section", { className: "tokens-list", "aria-label": "Token balances" },
            tokensList.map(t => {
              const bal = balances[t.symbol] || 0;
              const price = prices[t.symbol] || 0;
              return e("article", {
                key: t.symbol, className: "token-item",
                onClick: () => {
                  // On click token open withdraw modal with token preselected SPL or SOL
                  if (t.symbol === "SOL") {
                    setShowWithdraw(true);
                    setSplWithdrawTokenSymbol("FIXR"); // default SPL token for SPL withdraw
                    setWithdrawAmount('');
                    setWithdrawAddress('');
                  } else {
                    setSplWithdrawTokenSymbol(t.symbol);
                    setShowWithdraw(true);
                    setSplWithdrawAmount('');
                    setSplWithdrawAddress('');
                  }
                },
                tabIndex: 0,
                role: "button",
                "aria-label": `Balance and price of ${t.symbol}, click to withdraw`
              },
                e(TokenLogo, { token: t }),
                e("div", { className: "token-info" },
                  e("div", { className: "token-symbol" }, t.symbol),
                  e("div", { className: "token-balance" }, `Balance: ${bal.toFixed(t.decimals)}`),
                  e("div", { className: "token-price" }, `Price: $${price.toFixed(4)}`),
                )
              );
            })
          ),

          e("div", { className: "button-bar" },
            e("button", { onClick: () => { setShowDeposit(true); setShowWithdraw(false); setShowSwap(false); setError(""); setStatus(""); }, type: "button", title: "Deposit Instruction" }, "Deposit"),
            e("button", { onClick: () => { setShowWithdraw(true); setShowDeposit(false); setShowSwap(false); setError(""); setStatus(""); }, type: "button", title: "Withdraw Tokens" }, "Withdraw"),
            e("button", { onClick: () => { setShowSwap(true); setShowWithdraw(false); setShowDeposit(false); setError(""); setStatus(""); }, type: "button", title: "Swap SOL ⇄ FIXR" }, "Swap")
          ),

          walletConnected && showDeposit && e(Overlay, null, e(Deposit)),
          walletConnected && showWithdraw && e(Overlay, null, e(Withdraw)),
          walletConnected && showSwap && e(Overlay, null, e(Swap)),

          !walletConnected && e("p", {
            style: {
              color: "#666",
              fontSize: "0.9rem",
              textAlign: "center",
              marginTop: "16px",
            }
          },
            "Connect your Phantom Wallet via the button top-right to get started."),

          // Show small connected wallet addr in header when connected
          walletConnected && e("div", {
            id: "walletAddrShort",
            style: {
              position: "fixed",
              top: "12px",
              right: "130px",
              color: "#aaa",
              fontSize: "0.75rem",
              fontFamily: "monospace",
              userSelect: "text",
              backgroundColor: "#1e90ff33",
              padding: '4px 8px',
              borderRadius: '8px',
              zIndex: 20,
              whiteSpace: "nowrap",
              pointerEvents: "none"
            }
          }, shortAddress(publicKey))
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    })();
  </script>
</body>

</html>
