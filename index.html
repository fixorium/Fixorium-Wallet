 <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fixorium Swap</title>
    <script src="https://unpkg.com/@solana/web3.js@1.89.0/lib/index.iife.js"></script>
    <style>
      body { font-family: sans-serif; background: #f3f4f6; padding: 1rem; }
      .container { max-width: 400px; margin: auto; background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
      .button { background: #16a34a; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; }
      .button:hover { background: #15803d; }
      .input, select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 0.375rem; border: 1px solid #ccc; }
      #spinner { text-align: center; color: #4b5563; animation: pulse 2s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Fixorium Swap</h1>
        <button id="connectBtn" class="button">Connect Wallet</button>
      </div>

      <div id="walletAddress" style="font-size: 0.875rem; color: #6b7280;"></div>
      <div id="walletBalance" style="font-size: 0.875rem; color: #6b7280;"></div>
      <div id="tokenBalances" style="font-size: 0.875rem; color: #6b7280; white-space: pre-line;"></div>

      <label>Search From Token</label>
      <input id="fromSearch" class="input" placeholder="Search token..." />

      <label>From Token</label>
      <select id="fromToken" class="input"></select>

      <label>Search To Token</label>
      <input id="toSearch" class="input" placeholder="Search token..." />

      <label>To Token</label>
      <select id="toToken" class="input"></select>

      <label>Amount</label>
      <input id="amount" type="number" step="any" class="input" placeholder="Enter amount" />

      <label>Slippage (%)</label>
      <input id="slippage" type="number" value="0.5" step="0.1" class="input" />

      <button id="quoteBtn" class="button" style="background: #2563eb;">Get Quote</button>
      <div id="quoteResult" style="font-size: 0.875rem; color: #374151;"></div>

      <button id="swapBtn" class="button">Execute Swap</button>

      <div id="spinner" class="hidden">Loading...</div>
      <div id="status" style="font-size: 0.875rem; text-align: center;"></div>
    </div>

    <script>
      const { Connection, PublicKey, Transaction } = solanaWeb3;
      const connection = new Connection("https://api.mainnet-beta.solana.com");
      let wallet, publicKey, tokenMap = {}, topTokens = [];

      async function fetchTokens() {
        try {
          document.getElementById("spinner").classList.remove("hidden");
          const res = await fetch("https://quote-api.jup.ag/v6/tokens");
          const text = await res.text();
          const data = JSON.parse(text);

          const sorted = [...data].sort((a, b) =>
            (a.marketCapRank ?? 99999) - (b.marketCapRank ?? 99999) ||
            b.price - a.price
          ).slice(0, 10);

          topTokens = sorted;
          tokenMap = sorted.reduce((acc, t) => (acc[t.address] = t, acc), {});

          populateSelects(sorted);
        } catch (err) {
          console.error("Token fetch error:", err);
          alert("Failed to fetch tokens: " + err.message);
        } finally {
          document.getElementById("spinner").classList.add("hidden");
        }
      }

      function populateSelects(tokens) {
        const from = document.getElementById("fromToken");
        const to = document.getElementById("toToken");
        from.innerHTML = "";
        to.innerHTML = "";

        for (const token of tokens) {
          const label = `${token.symbol} ($${token.price?.toFixed(2) ?? 'N/A'})`;
          const opt1 = new Option(label, token.address);
          const opt2 = new Option(label, token.address);
          from.appendChild(opt1);
          to.appendChild(opt2);
        }
      }

      function filterTokens(inputId, selectId) {
        const search = document.getElementById(inputId).value.toLowerCase();
        const filtered = topTokens.filter(t => t.symbol.toLowerCase().includes(search));
        populateFilteredSelect(filtered, selectId);
      }

      function populateFilteredSelect(tokens, selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = "";
        for (const token of tokens) {
          const label = `${token.symbol} ($${token.price?.toFixed(2) ?? 'N/A'})`;
          const opt = new Option(label, token.address);
          select.appendChild(opt);
        }
      }

      async function showBalances() {
        if (!publicKey || !tokenMap) return;
        const lamports = await connection.getBalance(publicKey);
        document.getElementById("walletBalance").innerText = `SOL Balance: ${(lamports / 1e9).toFixed(4)} SOL`;

        const accounts = await connection.getParsedTokenAccountsByOwner(publicKey, {
          programId: new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
        });
        const tokenDisplay = [];

        for (const acc of accounts.value) {
          const info = acc.account.data.parsed.info;
          const mint = info.mint;
          const amount = info.tokenAmount.uiAmount;
          if (tokenMap[mint] && amount > 0) {
            tokenDisplay.push(`${tokenMap[mint].symbol}: ${amount.toFixed(4)}`);
          }
        }
        document.getElementById("tokenBalances").innerText = tokenDisplay.join("\n");
      }

      async function connectWallet() {
        if (!window.solana || !window.solana.isPhantom) return alert("Phantom wallet not found");
        const resp = await window.solana.connect();
        wallet = window.solana;
        publicKey = resp.publicKey;
        document.getElementById("walletAddress").innerText = `Wallet: ${publicKey.toBase58()}`;
        await showBalances();
      }

      async function getQuote() {
        const inputMint = document.getElementById("fromToken").value;
        const outputMint = document.getElementById("toToken").value;
        const amountRaw = parseFloat(document.getElementById("amount").value || 0);
        const slippageBps = parseFloat(document.getElementById("slippage").value || 0.5) * 100;

        if (!inputMint || !outputMint || amountRaw <= 0) return alert("Invalid input");

        const inputDecimals = tokenMap[inputMint].decimals;
        const amount = Math.floor(amountRaw * 10 ** inputDecimals);

        try {
          const res = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}`);
          const quote = await res.json();
          if (quote?.outAmount) {
            const outAmount = quote.outAmount / 10 ** tokenMap[outputMint].decimals;
            document.getElementById("quoteResult").innerText = `You'll receive ≈ ${outAmount.toFixed(6)} ${tokenMap[outputMint].symbol}`;
            window.latestRoute = quote;
          } else {
            document.getElementById("quoteResult").innerText = "No quote available.";
          }
        } catch (err) {
          console.error("Quote fetch error:", err);
          document.getElementById("quoteResult").innerText = "Failed to fetch quote.";
        }
      }

      async function executeSwap() {
        const route = window.latestRoute;
        if (!route) return alert("No route to execute");

        try {
          const res = await fetch("https://quote-api.jup.ag/v6/swap", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              route,
              userPublicKey: publicKey.toBase58(),
              wrapUnwrapSOL: true,
              feeAccount: "H4qKn8FMFha8jJuj8xMryMqRhH3h7GjLuxw7TVixpump"
            }),
          });

          const body = await res.text();
          const parsed = JSON.parse(body);
          const { swapTransaction } = parsed;
          if (!swapTransaction) throw new Error("No swap transaction returned");

          const txBuf = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
          const tx = Transaction.from(txBuf);
          const signed = await wallet.signTransaction(tx);
          const sig = await connection.sendRawTransaction(signed.serialize());
          document.getElementById("status").innerHTML = `✅ <a href='https://solscan.io/tx/${sig}' target='_blank'>View on Solscan</a>`;
          await showBalances();
        } catch (err) {
          console.error("Swap error:", err);
          document.getElementById("status").innerText = `Swap failed: ${err.message}`;
        }
      }

      // Event bindings
      document.getElementById("connectBtn").onclick = connectWallet;
      document.getElementById("quoteBtn").onclick = getQuote;
      document.getElementById("swapBtn").onclick = executeSwap;
      document.getElementById("fromSearch").oninput = () => filterTokens("fromSearch", "fromToken");
      document.getElementById("toSearch").oninput = () => filterTokens("toSearch", "toToken");

      fetchTokens();
    </script>
  </body>
</html>
