 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fixorium Solana SPL Token Swap dApp</title>

  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- solana-web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.75.0/lib/index.iife.min.js"></script>
  <!-- solana-spl-token -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 480px;
      margin: 30px auto;
      font-size: 14px;
      background: #f9f9f9;
      color: #222;
      padding: 0 15px 50px 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }
    h2 {
      font-weight: 600;
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.4rem;
    }
    button {
      cursor: pointer;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 0.9rem;
      padding: 8px 16px;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not([disabled]){
      background-color: #005ecb;
    }
    button[disabled] {
      background-color: #a0a0a0;
      cursor: not-allowed;
    }
    fieldset {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-top: 12px;
      background: white;
    }
    legend {
      font-weight: 700;
      font-size: 1.1rem;
      padding: 0 8px;
    }
    label {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 4px;
      display: block;
    }
    select, input[type=number] {
      width: 100%;
      padding: 6px 8px;
      font-size: 0.9rem;
      border: 1px solid #bbb;
      border-radius: 5px;
      box-sizing: border-box;
      margin-top: 4px;
      margin-bottom: 6px;
      transition: border-color 0.2s ease;
    }
    select:focus, input[type=number]:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 3px #007aff66;
    }
    small {
      color: #555;
      display: block;
      margin-top: -4px;
      margin-bottom: 12px;
      font-size: 0.75rem;
      user-select: text;
      word-break: break-all;
    }
    .btn-swap {
      margin: 10px auto;
      display: block;
      font-weight: 600;
      font-size: 1rem;
      user-select: none;
    }
    .route-box {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      background: white;
      transition: border-color 0.25s ease, background-color 0.25s ease;
      user-select: none;
    }
    .route-box:hover {
      border-color: #007aff;
      background-color: #f0f8ff;
    }
    .route-box.selected {
      border-color: #007aff;
      background-color: #e2f0ff;
    }
    p.status {
      margin-top: 20px;
      word-wrap: break-word;
      font-size: 0.85rem;
      color: #005ecb;
      font-weight: 600;
      user-select: text;
    }
    footer {
      margin-top: 40px;
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      user-select:none;
    }
    a {
      color: #007aff;
      text-decoration: underline;
      user-select: text;
    }
    .logo-inline {
      vertical-align: middle;
      width: 16px;
      height: 16px;
      margin-right: 6px;
      border-radius: 3px;
      object-fit: contain;
      user-select:none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect, useCallback, StrictMode } = React;
    const { Connection, PublicKey, clusterApiUrl, Transaction } = solanaWeb3;
    const { TOKEN_PROGRAM_ID } = splToken;

    const SOL_MINT = 'So11111111111111111111111111111111111111112';
    const JUPITER_API_BASE = 'https://quote-api.jup.ag/v4';

    // Verified 10 trending tokens on mainnet-beta with logos
    const tokensList = [
      {
        address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
        symbol: 'USDC',
        name: 'USD Coin',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/logo.png',
      },
      {
        address: 'Es9vMFrzaCER7N1TvjVqauDziYbPEmxW5M9VpX1TTd8C',
        symbol: 'USDT',
        name: 'Tether USD',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/Es9vMFrzaCER7N1TvjVqauDziYbPEmxW5M9VpX1TTd8C/logo.png',
      },
      {
        address: 'SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt',
        symbol: 'SRM',
        name: 'Serum',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt/logo.png',
      },
      {
        address: '4k3Dyjzvzp8e4wJ7TGLkpvJ7YenqR6AMx7jxUnnGghPf',
        symbol: 'RAY',
        name: 'Raydium',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/4k3Dyjzvzp8e4wJ7TGLkpvJ7YenqR6AMx7jxUnnGghPf/logo.png',
      },
      {
        address: 'orcaE6ZxFtoajT2zF3ahNHPs2bWkm8c5KxjxHPv3RRZ4',
        symbol: 'ORCA',
        name: 'Orca',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/orcaE6ZxFtoajT2zF3ahNHPs2bWkm8c5KxjxHPv3RRZ4/logo.png',
      },
      {
        address: 'FTTGFt2jEQq3RpAm3qNihC84sFD3AYwhzMTeKuFzQZ9',
        symbol: 'FTT',
        name: 'FTT Token',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/FTTGFt2jEQq3RpAm3qNihC84sFD3AYwhzMTeKuFzQZ9/logo.png',
      },
      {
        address: 'DezXAZ8z7PnrnRJjzQeCQBmfPtujfq6nCzFFWiP2LsXX',
        symbol: 'BONK',
        name: 'Bonk Token',
        decimals: 0,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/DezXAZ8z7PnrnRJjzQeCQBmfPtujfq6nCzFFWiP2LsXX/logo.png',
      },
      {
        address: '7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU',
        symbol: 'SAMO',
        name: 'Samoyedcoin',
        decimals: 9,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU/logo.png',
      },
      {
        address: 'CopeJxzv7ss9ruvT8WDD7i5ZRtcQBNM6AtURNyagova',
        symbol: 'COPE',
        name: 'COPE Token',
        decimals: 9,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/CopeJxzv7ss9ruvT8WDD7i5ZRtcQBNM6AtURNyagova/logo.png',
      },
      {
        address: 'StepRfZh3P5GbAmMKB3vTf1GhT7jDLpD5ZYhKv9HQ9H',
        symbol: 'STEP',
        name: 'Step Finance',
        decimals: 6,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/assets/StepRfZh3P5GbAmMKB3vTf1GhT7jDLpD5ZYhKv9HQ9H/logo.png',
      }
    ];

    const network = clusterApiUrl('mainnet-beta');
    const connection = new Connection(network, 'confirmed');

    function App() {
      const [walletConnected, setWalletConnected] = useState(false);
      const [publicKey, setPublicKey] = useState(null);
      const [solBalance, setSolBalance] = useState(null);
      const [fromToken, setFromToken] = useState({
        address: SOL_MINT,
        symbol: 'SOL',
        name: 'SOL',
        decimals: 9,
        logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/info/logo.png',
      });
      const [toToken, setToToken] = useState(tokensList[0]);
      const [amount, setAmount] = useState('0');
      const [routes, setRoutes] = useState([]);
      const [selectedRoute, setSelectedRoute] = useState(null);
      const [loadingQuotes, setLoadingQuotes] = useState(false);
      const [swapping, setSwapping] = useState(false);
      const [txStatus, setTxStatus] = useState(null);
      const [tokenBalances, setTokenBalances] = useState({});

      // Connect Phantom wallet
      const connectWallet = useCallback(async () => {
        try {
          if (window.solana && window.solana.isPhantom) {
            const resp = await window.solana.connect();
            setPublicKey(new PublicKey(resp.publicKey.toString()));
            setWalletConnected(true);
            setTxStatus(null);
          } else {
            alert('Phantom wallet not found. Please install it from https://phantom.app/');
          }
        } catch (error) {
          alert('Wallet connection failed: ' + (error?.message ?? error));
        }
      }, []);

      // Disconnect wallet
      const disconnectWallet = useCallback(async () => {
        try {
          if (window.solana && window.solana.isPhantom) {
            await window.solana.disconnect();
            setWalletConnected(false);
            setPublicKey(null);
            setSolBalance(null);
            setTokenBalances({});
            setRoutes([]);
            setSelectedRoute(null);
            setTxStatus(null);
            setAmount('0');
          }
        } catch (e) {
          console.error('Error disconnecting wallet', e);
        }
      }, []);

      // Fetch SOL and SPL token balances when publicKey changes
      useEffect(() => {
        async function fetchBalances() {
          if (!publicKey) return;

          try {
            setSolBalance(null); // Loading indicator
            const balance = await connection.getBalance(publicKey);
            setSolBalance(balance / 1e9);

            let balances = {};
            for (const token of tokensList) {
              try {
                const mintPubkey = new PublicKey(token.address);
                const tokenAccounts = await connection.getTokenAccountsByOwner(publicKey, { mint: mintPubkey });
                if (tokenAccounts.value.length > 0) {
                  const accountInfo = await connection.getParsedAccountInfo(tokenAccounts.value[0].pubkey);
                  const uiAmount = accountInfo.value?.data?.parsed?.info?.tokenAmount?.uiAmount || 0;
                  balances[token.address] = uiAmount;
                } else {
                  balances[token.address] = 0;
                }
              } catch {
                balances[token.address] = 0;
              }
            }
            setTokenBalances(balances);
          } catch (e) {
            console.error('Error fetching balances:', e);
            alert('Error fetching balances. See console.');
            setSolBalance(0);
            setTokenBalances({});
          }
        }
        fetchBalances();
      }, [publicKey]);

      // Listen Phantom wallet connect/disconnect events
      useEffect(() => {
        if (!(window.solana && window.solana.isPhantom)) return;
        const onConnect = (publicKey) => {
          setPublicKey(new PublicKey(publicKey.toString()));
          setWalletConnected(true);
          setTxStatus(null);
        };
        const onDisconnect = () => {
          setWalletConnected(false);
          setPublicKey(null);
          setSolBalance(null);
          setTokenBalances({});
          setRoutes([]);
          setSelectedRoute(null);
          setTxStatus(null);
          setAmount('0');
        };
        window.solana.on('connect', onConnect);
        window.solana.on('disconnect', onDisconnect);

        if (window.solana.isConnected) {
          setPublicKey(new PublicKey(window.solana.publicKey.toString()));
          setWalletConnected(true);
        }

        return () => {
          if (window.solana.removeListener) {
            window.solana.removeListener('connect', onConnect);
            window.solana.removeListener('disconnect', onDisconnect);
          }
        };
      }, []);

      // Convert human amount to base units (lamports or decimals)
      const toBaseUnits = (amountStr, decimals) => {
        const floatVal = parseFloat(amountStr);
        if (isNaN(floatVal) || floatVal <= 0) return 0;
        return Math.round(floatVal * 10 ** decimals);
      };

      // Get quotes from Jupiter API
      const getSwapQuotes = async () => {
        if (!publicKey) {
          alert('Please connect your wallet first');
          return;
        }
        const amountNum = parseFloat(amount);
        if (isNaN(amountNum) || amountNum <= 0) {
          alert('Please enter a valid positive amount');
          return;
        }
        setLoadingQuotes(true);
        setRoutes([]);
        setSelectedRoute(null);
        setTxStatus(null);
        try {
          const inputMint = fromToken.symbol === 'SOL' ? SOL_MINT : fromToken.address;
          const outputMint = toToken.symbol === 'SOL' ? SOL_MINT : toToken.address;
          const inputAmount = toBaseUnits(amount, fromToken.decimals);
          if (inputAmount === 0) {
            alert('Invalid amount after conversion');
            setLoadingQuotes(false);
            return;
          }
          const response = await axios.get(`${JUPITER_API_BASE}/quote`, {
            params: {
              inputMint,
              outputMint,
              amount: inputAmount,
              slippageBps: 50, // 0.5% slippage
              swapMode: 'ExactIn',
            }
          });
          if (response.data && Array.isArray(response.data.data) && response.data.data.length > 0) {
            setRoutes(response.data.data);
            setSelectedRoute(response.data.data[0]);
          } else {
            alert('No swap routes found for this token pair/amount.');
            setRoutes([]);
            setSelectedRoute(null);
          }
        } catch (error) {
          console.error('Error fetching swap routes:', error);
          alert('Failed to fetch swap routes. See console.');
        }
        setLoadingQuotes(false);
      };

      // Execute swap transaction via Jupiter
      const executeSwap = async () => {
        if (!publicKey) {
          alert('Please connect your wallet first');
          return;
        }
        if (!selectedRoute) {
          alert('Please select a swap quote route');
          return;
        }
        setSwapping(true);
        setTxStatus(null);
        try {
          // Get swap transactions from Jupiter
          const response = await axios.post(`${JUPITER_API_BASE}/swap`, {
            route: selectedRoute,
            userPublicKey: publicKey.toBase58(),
          });
          const data = response.data;
          if (!data || !data.swapTransactions) {
            alert('Failed to get swap transactions from Jupiter API');
            setSwapping(false);
            return;
          }

          // Setup transaction if exists
          if (data.swapTransactions.setupTransaction) {
            let setupTx = Transaction.from(Buffer.from(data.swapTransactions.setupTransaction, 'base64'));
            setupTx.feePayer = publicKey;
            const { blockhash } = await connection.getLatestBlockhash();
            setupTx.recentBlockhash = blockhash;
            const signedSetupTx = await window.solana.signTransaction(setupTx);
            const setupTxid = await connection.sendRawTransaction(signedSetupTx.serialize());
            setTxStatus(`Setup tx sent: ${setupTxid}`);
            await connection.confirmTransaction(setupTxid, 'confirmed');
          }

          // Main swap transaction
          let swapTx = Transaction.from(Buffer.from(data.swapTransactions.swapTransaction, 'base64'));
          swapTx.feePayer = publicKey;
          const { blockhash } = await connection.getLatestBlockhash();
          swapTx.recentBlockhash = blockhash;

          const signedSwapTx = await window.solana.signTransaction(swapTx);
          const swapTxid = await connection.sendRawTransaction(signedSwapTx.serialize());
          setTxStatus(`Swap tx submitted: ${swapTxid}`);
          await connection.confirmTransaction(swapTxid, 'confirmed');
          setTxStatus(`Swap confirmed: ${swapTxid}`);

          // Refresh balances
          const newSolBalance = await connection.getBalance(publicKey);
          setSolBalance(newSolBalance / 1e9);

          let balances = {};
          // Refresh token balances
          for (const token of tokensList) {
            try {
              const mintPubkey = new PublicKey(token.address);
              const tokenAccounts = await connection.getTokenAccountsByOwner(publicKey, { mint: mintPubkey });
              if (tokenAccounts.value.length > 0) {
                const accountInfo = await connection.getParsedAccountInfo(tokenAccounts.value[0].pubkey);
                const uiAmount = accountInfo.value?.data?.parsed?.info?.tokenAmount?.uiAmount || 0;
                balances[token.address] = uiAmount;
              } else {
                balances[token.address] = 0;
              }
            } catch {
              balances[token.address] = 0;
            }
          }
          setTokenBalances(balances);
          setAmount('0');
          setRoutes([]);
          setSelectedRoute(null);

        } catch (error) {
          console.error('Swap failed', error);
          alert(`Swap failed: ${error?.message ?? error}`);
        }
        setSwapping(false);
      };

      // Show balances with 4 decimals or loading indicator
      const displayBalance = (token) => {
        if (token.symbol === 'SOL') {
          if (solBalance === null) return 'Loading...';
          return solBalance.toFixed(4);
        }
        const bal = tokenBalances[token.address];
        if (bal === undefined) return 'Loading...';
        return bal.toFixed(4);
      };

      // Swap from and to token pair
      const swapFromTo = () => {
        const oldFrom = fromToken;
        setFromToken(toToken);
        setToToken(oldFrom);
        setAmount('0');
        setRoutes([]);
        setSelectedRoute(null);
        setTxStatus(null);
      };

      // Render Token option with logo
      const TokenOption = ({token}) => (
        <>
          {token.logoURI && <img alt={token.symbol} src={token.logoURI} className="logo-inline" />} {token.symbol}
        </>
      );

      return (
        <div>
          <h2>Fixorium Solana SPL Token Swap dApp</h2>

          {!walletConnected ? (
            <button onClick={connectWallet} style={{ minWidth: '100%' }} type="button" aria-label="Connect Phantom Wallet">
              Connect Phantom Wallet
            </button>
          ) : (
            <div style={{ marginBottom: 15 }}>
              <p style={{ wordBreak: 'break-word', userSelect: 'text' }}><b>Wallet:</b> {publicKey?.toBase58()}</p>
              <p><b>SOL balance:</b> {solBalance === null ? 'Loading...' : `${solBalance.toFixed(4)} SOL`}</p>
              <button onClick={disconnectWallet} style={{ padding: '6px 12px' }} type="button" aria-label="Disconnect Wallet">
                Disconnect
              </button>
            </div>
          )}

          <fieldset disabled={!walletConnected || loadingQuotes || swapping} aria-disabled={!walletConnected || loadingQuotes || swapping}>
            <legend>Swap</legend>

            <label htmlFor="fromSelect">From:</label>
            <select
              id="fromSelect"
              aria-label="From token"
              value={fromToken.address}
              onChange={e => {
                const sel = tokensList.find(t => t.address === e.target.value) || 
                  (e.target.value === SOL_MINT ? {
                    address: SOL_MINT,
                    symbol: 'SOL',
                    name: 'SOL',
                    decimals: 9,
                    logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/info/logo.png',
                  } : null);
                if (sel) {
                  setFromToken(sel);
                  setRoutes([]);
                  setSelectedRoute(null);
                  setAmount('');
                  setTxStatus(null);
                }
              }}
            >
              <option value={SOL_MINT}>SOL</option>
              {tokensList.map(token => (
                <option value={token.address} key={token.address}>{token.symbol}</option>
              ))}
            </select>
            <small>Balance: {displayBalance(fromToken)}</small>

            <button
              className="btn-swap"
              type="button"
              onClick={swapFromTo}
              disabled={!walletConnected || swapping || loadingQuotes}
              aria-label="Swap from and to tokens"
            >
              ⇅ Swap from/to
            </button>

            <label htmlFor="toSelect">To:</label>
            <select
              id="toSelect"
              aria-label="To token"
              value={toToken.address}
              onChange={e => {
                const sel = tokensList.find(t => t.address === e.target.value) || 
                  (e.target.value === SOL_MINT ? {
                    address: SOL_MINT,
                    symbol: 'SOL',
                    name: 'SOL',
                    decimals: 9,
                    logoURI: 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/solana/info/logo.png',
                  } : null);
                if (sel) {
                  setToToken(sel);
                  setRoutes([]);
                  setSelectedRoute(null);
                  setAmount('');
                  setTxStatus(null);
                }
              }}
            >
              <option value={SOL_MINT}>SOL</option>
              {tokensList.map(token => (
                <option value={token.address} key={token.address}>{token.symbol}</option>
              ))}
            </select>
            <small>Balance: {displayBalance(toToken)}</small>

            <label htmlFor="amountInput">Amount ({fromToken.symbol}):</label>
            <input
              id="amountInput"
              type="number"
              min="0"
              step="any"
              placeholder="0"
              aria-label={`Amount of ${fromToken.symbol}`}
              value={amount}
              onChange={e => setAmount(e.target.value)}
              spellCheck="false"
              inputMode="decimal"
            />

            <button
              type="button"
              onClick={getSwapQuotes}
              disabled={loadingQuotes || !amount || parseFloat(amount) <= 0}
              style={{ minWidth: '100%' }}
              aria-label="Get swap quotes"
            >
              {loadingQuotes ? 'Loading quotes...' : 'Get Swap Quote'}
            </button>
          </fieldset>

          {/* Swap routes and selection */}
          {routes.length > 0 && !loadingQuotes && (
            <fieldset>
              <legend>Quotes</legend>
              <div style={{maxHeight: 250, overflowY: 'auto'}}>
                {routes.map(route => {
                  const expectedOut = (parseInt(route.outAmount) / 10 ** toToken.decimals).toFixed(6);
                  const priceImpactPct = (route.priceImpactPct * 100).toFixed(3);
                  const selected = selectedRoute?.id === route.id;
                  return (
                    <div
                      key={route.id}
                      className={`route-box${selected ? ' selected' : ''}`}
                      onClick={() => setSelectedRoute(route)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') setSelectedRoute(route);
                      }}
                      tabIndex="0"
                      role="button"
                      aria-pressed={selected}
                      aria-label={`Quote expected out ${expectedOut} ${toToken.symbol}. Price Impact ${priceImpactPct} percent. Click to select.`}
                    >
                      <div><b>Expected Out:</b> {expectedOut} {toToken.symbol}</div>
                      <div><b>Price Impact:</b> {priceImpactPct}%</div>
                    </div>
                  );
                })}
              </div>
              <button
                type="button"
                onClick={executeSwap}
                disabled={!selectedRoute || swapping}
                style={{ marginTop: 15, minWidth: '100%' }}
                aria-label={`Execute swap from ${amount} ${fromToken.symbol} to ${toToken.symbol}`}
              >
                {swapping ? 'Swapping...' : `Swap ${amount} ${fromToken.symbol} → ${toToken.symbol}`}
              </button>
            </fieldset>
          )}

          {txStatus && <p className="status" aria-live="polite" aria-atomic="true">{txStatus}</p>}

          <footer>
            Powered by Solana, Phantom &amp; <a href="https://jup.ag/" target="_blank" rel="noopener noreferrer">Jupiter Aggregator</a>
          </footer>
        </div>
      );
    }

    const rootElem = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElem);
    root.render(<StrictMode><App /></StrictMode>);
  </script>
</body>
</html>
