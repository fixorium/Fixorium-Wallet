 <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fixorium Swap</title>
    <script src="https://unpkg.com/@solana/web3.js@1.89.0/lib/index.iife.js"></script>
  </head>
  <body style="background-color: #f3f4f6; padding: 1rem; font-family: sans-serif;">
    <div style="max-width: 400px; margin: 0 auto; background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.25rem; font-weight: bold;">Fixorium Swap</h1>
        <button id="connectBtn" style="background-color: #16a34a; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; border: none; cursor: pointer;">Connect Wallet</button>
      </div>

      <div id="walletAddress" style="font-size: 0.875rem; color: #6b7280; overflow-wrap: break-word;"></div>

      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
        <label>From Token</label>
        <select id="fromToken" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"></select>

        <label>To Token</label>
        <select id="toToken" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"></select>

        <label>Amount</label>
        <input id="amount" type="number" step="any" placeholder="Enter amount" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />

        <label>Slippage (%)</label>
        <input id="slippage" type="number" value="0.5" step="0.1" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />

        <button id="quoteBtn" style="background-color: #2563eb; color: white; padding: 0.5rem; border-radius: 0.375rem; border: none; cursor: pointer;">Get Quote</button>
        <div id="quoteResult" style="font-size: 0.875rem; color: #374151;"></div>

        <button id="swapBtn" style="background-color: #16a34a; color: white; padding: 0.5rem; border-radius: 0.375rem; border: none; cursor: pointer;">Execute Swap</button>
      </div>

      <div id="spinner" style="display: none; text-align: center; margin-top: 1rem;">
        <span style="color: #4b5563;">Loading...</span>
      </div>

      <div id="status" style="font-size: 0.875rem; text-align: center; margin-top: 0.75rem;"></div>
    </div>

    <script>
      const { Connection, PublicKey, Transaction } = solanaWeb3;
      const connection = new Connection("https://api.mainnet-beta.solana.com");
      let wallet, publicKey, tokenMap;

      async function fetchTokens() {
        try {
          document.getElementById("spinner").style.display = "block";
          const res = await fetch("https://quote-api.jup.ag/v6/tokens");
          const data = await res.json();
          tokenMap = data.reduce((acc, t) => (acc[t.address] = t, acc), {});
          for (const token of data) {
            const opt = new Option(`${token.symbol} ($${token.price.toFixed(2)})`, token.address);
            document.getElementById("fromToken").appendChild(opt.cloneNode(true));
            document.getElementById("toToken").appendChild(opt);
          }
        } catch (err) {
          console.error("Token fetch error:", err);
          alert("Failed to fetch token list.");
        } finally {
          document.getElementById("spinner").style.display = "none";
        }
      }

      async function connectWallet() {
        if (!window.solana || !window.solana.isPhantom) return alert("Phantom wallet not found");
        const resp = await window.solana.connect();
        wallet = window.solana;
        publicKey = resp.publicKey;
        document.getElementById("walletAddress").innerText = `Wallet: ${publicKey.toBase58()}`;
      }

      async function getQuote() {
        const inputMint = document.getElementById("fromToken").value;
        const outputMint = document.getElementById("toToken").value;
        const amountRaw = parseFloat(document.getElementById("amount").value || 0);
        const slippageBps = parseFloat(document.getElementById("slippage").value || 0.5) * 100;

        if (!inputMint || !outputMint || amountRaw <= 0) return alert("Invalid input");

        const inputDecimals = tokenMap[inputMint].decimals;
        const amount = Math.floor(amountRaw * 10 ** inputDecimals);

        try {
          const res = await fetch(`https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}`);
          const quote = await res.json();
          if (quote?.outAmount) {
            const outAmount = quote.outAmount / 10 ** tokenMap[outputMint].decimals;
            document.getElementById("quoteResult").innerText = `You'll receive ≈ ${outAmount.toFixed(6)} ${tokenMap[outputMint].symbol}`;
            window.latestRoute = quote;
          } else {
            document.getElementById("quoteResult").innerText = "No quote available.";
          }
        } catch (err) {
          console.error("Quote fetch error:", err);
          document.getElementById("quoteResult").innerText = "Failed to fetch quote.";
        }
      }

      async function executeSwap() {
        const route = window.latestRoute;
        if (!route) return alert("No route to execute");

        try {
          const res = await fetch("https://quote-api.jup.ag/v6/swap", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              route,
              userPublicKey: publicKey.toBase58(),
              wrapUnwrapSOL: true,
              feeAccount: "H4qKn8FMFha8jJuj8xMryMqRhH3h7GjLuxw7TVixpump"
            }),
          });

          const body = await res.text();
          let parsed;
          try {
            parsed = JSON.parse(body);
          } catch (err) {
            console.error("Invalid JSON response:", body);
            document.getElementById("status").innerText = "Swap failed: Invalid response.";
            return;
          }

          const { swapTransaction } = parsed;
          if (!swapTransaction) throw new Error("No swap transaction returned");

          const txBuf = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
          const tx = Transaction.from(txBuf);
          const signed = await wallet.signTransaction(tx);
          const sig = await connection.sendRawTransaction(signed.serialize());
          document.getElementById("status").innerHTML = `✅ <a href='https://solscan.io/tx/${sig}' style='color: #2563eb; text-decoration: underline;' target='_blank'>View on Solscan</a>`;
        } catch (err) {
          console.error("Swap error:", err);
          document.getElementById("status").innerText = `Swap failed: ${err.message}`;
        }
      }

      document.getElementById("connectBtn").onclick = connectWallet;
      document.getElementById("quoteBtn").onclick = getQuote;
      document.getElementById("swapBtn").onclick = executeSwap;

      fetchTokens();
    </script>
  </body>
</html>
